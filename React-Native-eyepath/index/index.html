<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tmap 지도</title>
  <script src="https://apis.openapi.sk.com/tmap/vectorjs?version=1&appKey=OjCMpSA1xX1U1j0OSGb7SjbWT8F13RI18ZVR17z2"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    html, body, #map_div {
      position: absolute;
      width: 100%;
      height: 100%;
      margin: 0;
    }
  </style>
  <script type="text/javascript">
    var map;
    var marker;
    var polyline;

    function initTmap() {
      map = new Tmapv3.Map("map_div", {
        center: new Tmapv3.LatLng(37.56520450, 126.98702028),
        width: "100%",
        height: "100%",
        zoom: 15,
      });
    }

    function setMapCenterAndMarker(lat, lng) {
      var originalCenter = new Tmapv3.LatLng(parseFloat(lat), parseFloat(lng));
      var offsetLat = 0.0015;
      var visualCenter = new Tmapv3.LatLng(originalCenter.lat() - offsetLat, originalCenter.lng());

      map.setCenter(visualCenter);
      map.setZoom(17);

      if (marker) marker.setMap(null);
      marker = new Tmapv3.Marker({ position: originalCenter, map: map });
    }

    function requestAndDrawRoute(startLat, startLng, endLat, endLng) {
      axios.post("https://eyepath.duckdns.org/docs", {
        start_x: startLng,
        start_y: startLat,
        end_x: endLng,
        end_y: endLat,
        description: "길안내"
      })
      .then(response => {
        const data = response.data;
        if (!Array.isArray(data)) {
          console.error("서버 응답 형식 오류", data);
          return;
        }

        const latlngs = data.map(point => new Tmapv3.LatLng(point.lat, point.lon));

        if (polyline) polyline.setMap(null); // 기존 경로 삭제

        polyline = new Tmapv3.Polyline({
          path: latlngs,
          strokeColor: "#FF0000",
          strokeWeight: 6,
          map: map
        });

        if (latlngs.length > 0) {
          map.setCenter(latlngs[0]);
          map.setZoom(17);
        }
      })
      .catch(error => {
        console.error("경로 요청 실패", error);
      });
    }

    function handleMessage(event) {
      try {
        var data = JSON.parse(event.data);
        if (data.action === 'setLocation') {
          setMapCenterAndMarker(data.lat, data.lng);
        } else if (data.action === 'setRoute') {
          requestAndDrawRoute(data.startLat, data.startLng, data.endLat, data.endLng);
        }
      } catch (e) {
        console.error('Invalid message data', e);
      }
    }

    window.addEventListener('message', handleMessage);
    document.addEventListener('message', handleMessage);
    document.addEventListener('DOMContentLoaded', initTmap);

    window.onload = function () {
      window.ReactNativeWebView?.postMessage(JSON.stringify({ action: 'ready' }));
    };
  </script>
</head>
<body>
  <div id="map_div"></div>
</body>
</html>
